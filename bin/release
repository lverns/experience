#! /usr/bin/env bash

# Script expects to be run from the project root

set -e

VERSION_CHANGE="$1"
OUTPUT_JAR="target/experience.jar"
GROUP_ID="com.roomkey"
ARTIFACT_ID="experience"

if [ -z "$VERSION_CHANGE" ];
then
    echo "The first argument must be one of: major, minor, patch, major-rc, minor-rc, major-release, or minor-release."
    echo "See https://github.com/workframers/garamond for more information."
    exit 1
fi

if [ -e "pom.xml" ];
then
    echo "Please delete pom.xml before running this script"
    exit 1
fi

echo "WARNING: I hope you're running this from a clean repo, because we don't actually abort when it's dirty"

clojure -Agaramond -m garamond.main "$VERSION_CHANGE" \
	--tag \
	--pom \
	--group-id "$GROUP_ID" \
	--artifact-id "$ARTIFACT_ID" \
	--scm-url https://github.com/roomkey/experience

VERSION=$(clojure -Agaramond -m garamond.main | sed 's/^v//')

clojure -Adepstar -m hf.depstar.jar "$OUTPUT_JAR"

clojure -Adeploy -m deploy "[\"$OUTPUT_JAR\" \"pom.xml\" {:url \"s3p://rk-maven/releases/\"} $GROUP_ID $ARTIFACT_ID \"$VERSION\"]"

rm pom.xml
